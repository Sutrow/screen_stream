services:
  xray:
    image: teddysun/xray:26.2.6
    container_name: xray
    restart: unless-stopped
    volumes:
      - ./config.json:/etc/xray/config.json:ro
    networks:
      - shared-network
    ports:
      - "8000:8000"

  stream-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stream-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - shared-network

  caddy:
    image: caddy:2.11-alpine
    container_name: caddy
    restart: unless-stopped
    profiles: ["prod"]
    environment:
      DOMAIN: ${CADDY_DOMAIN}
    cap_add:
      - NET_ADMIN
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1:2019/config/ >/dev/null 2>&1" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - shared-network

  chatmock:
    build:
      context: ./chatmock/ChatMock
      dockerfile: Dockerfile
    restart: unless-stopped
    network_mode: "service:xray"
    depends_on:
      - xray
    environment:
      - CHATMOCK_HOST=0.0.0.0
      - CHATMOCK_PORT=8000
      - CHATGPT_LOCAL_HOME=/data
      - HTTP_PROXY=http://127.0.0.1:1080
      - HTTPS_PROXY=http://127.0.0.1:1080
      - http_proxy=http://127.0.0.1:1080
      - https_proxy=http://127.0.0.1:1080
      - NO_PROXY=localhost,127.0.0.1
    container_name: chatmock
    command: ["serve"]
    volumes:
      - ./auth.json:/root/.codex/auth.json
      - chatmock_data:/data
      - ./chatmock/ChatMock/prompt.md:/app/prompt.md:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8000/health').status==200 else 1)\" "]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

volumes:
  chatmock_data:
  caddy_data:
  caddy_config:

networks:
  shared-network:
    driver: bridge